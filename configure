#!/usr/bin/env bash

BASH_ON=1
TOTP_ON=1
PWGEN_ON=1
STATS_ON=1
DIFF_ON=1
APPS=(lb lb-rekey lb-rw)
BIN_PATH="bin/"
GENERATED="internal/generated.go"

for i in "$@"; do
    case $i in
        --disable-bash-completions)
            BASH_ON=0
            shift
            ;;
        --disable-totp)
            TOTP_ON=0
            shift
            ;;
        --disable-pwgen)
            PWGEN_ON=0
            shift
            ;;
        --disable-git)
            STATS_ON=0
            DIFF_ON=0
            shift
            ;;
        *)
            echo "unknown option: $i"
            exit 1
            ;;
    esac
done

if [ $BASH_ON -eq 1 ]; then
    APPS+=(lb-bash)
fi
if [ $TOTP_ON -eq 1 ]; then
    APPS+=(lb-totp)
fi
if [ $PWGEN_ON -eq 1 ]; then
    APPS+=(lb-pwgen)
fi
if [ $STATS_ON -eq 1 ]; then
    APPS+=(lb-stats)
fi
if [ $DIFF_ON -eq 1 ]; then
    APPS+=(lb-diff)
fi

_generate() {
    local binapps app cnt binapp
    binapps=()
    for app in ${APPS[@]}; do
        binapps+=($BIN_PATH$app)
    done
    echo "# Autogenerated file
FLAGS  := -ldflags \"-X main.version=\$(shell git log -n 1 --format=%h)\" -trimpath -buildmode=pie -mod=readonly -modcacherw

all: prep ${binapps[@]} test

test:
    make -C tests

prep:
    mkdir -p $BIN_PATH

clean:
    rm -rf $BIN_PATH
    rm -f $GENERATED
"

    cnt=0
    for binapp in ${binapps[@]}; do
        app=${APPS[$cnt]}
        cnt=$((cnt+1))
        echo "$binapp: \$(shell find . -type f -name '*.go') go.*"
        echo "    go build -o $binapp \$(FLAGS) cmd/$app/main.go"
        echo
    done
}

_generate | sed 's/^    /\t/g' > Makefile
